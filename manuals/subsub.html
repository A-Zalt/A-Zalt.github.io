<html>
    <head>
        <title>Manual Generator</title>
    </head>
    <body>
        <table border="1">
            <tr>
                <td>
                    <h3>Parent Submission</h3>
                    <label for="resume">Upload a manual:</label>
                    <input type="file" onchange="fileChanged(this)" onclick="this.value=null;" id="resume" name="resume" accept=".json" /><br><br>
                    <label for="comment">Manual Comment</label>
                    <input type="text" id="comment" size="50" placeholder="Manual Comment"/><br>
                    <label for="date">Manual Date (local timezone)</label>
                    <input type="date" id="date"/><input type="time" id="time"/><input type="number" min="0" max="59" id="seconds" placeholder="Seconds" size="5"><input type="number" min="0" max="999" id="millis" placeholder="Millis" size="3">
                    <button id="currentDate" onclick="setDate(Date.now())">Set to current date</button><br>
                    <input type="number" id="unix" placeholder="UNIX timestamp" size="15">
                    <button id="unixSeconds" onclick="setDate(Number($('unix').value) * 1000)">Set date (seconds)</button>
                    <button id="unixMillis" onclick="setDate(Number($('unix').value))">Set date (milliseconds)</button>
                </td>
            </tr>
            <tr>

                <td>
                    <h3>Subsubmission</h3>
                    <label for="comment_subsub">Manual Comment</label>
                    <input type="text" id="comment_subsub" size="50" placeholder="Manual Comment"/><br>
                    <label for="date_subsub">Manual Date (local timezone)</label>
                    <input type="date" id="date_subsub"/><input type="time" id="time_subsub"/><input type="number" min="0" max="59" id="seconds_subsub" placeholder="Seconds" size="5"><input type="number" min="0" max="999" id="millis_subsub" placeholder="Millis" size="3">
                    <button id="currentDate" onclick="setSSDate(Date.now())">Set to current date</button><br>
                    <input type="number" id="unix_subsub" placeholder="UNIX timestamp" size="15">
                    <button id="unixSeconds_ss" onclick="setSSDate(Number($('unix_subsub').value) * 1000)">Set date (seconds)</button>
                    <button id="unixMillis_ss" onclick="setSSDate(Number($('unix_subsub').value))">Set date (milliseconds)</button><br><br>
                    <div id="subsLabel">1/1 Subsubmissions</div><br>
                    <button id="left_ss" onclick="setSSIndex(ssIndex - 1)">&lt;</button>
                    <button id="add_ss" onclick="addSS()">+</button>
                    <button id="right_ss" onclick="setSSIndex(ssIndex + 1)">&gt;</button>
                    <button id="delete_ss" onclick="delSS()">Delete</button>
                    <button id="clear_ss" onclick="clearSS()">Clear</button><br>
                </td>
            </tr>
            <tr>

                <td>
                    <h3>Levels</h3>
                    <label for="id">Level ID</label>
                    <input type="number" id="id" placeholder="Level ID"><br>
                    <label for="level_name">Level Name</label>
                    <input type="text" id="level_name" placeholder="Level Name"><br>
                    <label for="username">Author Username</label>
                    <input type="text" id="username" placeholder="Username"><br>
                    <label for="user_id">Author User ID</label>
                    <input type="number" id="user_id" placeholder="User ID"><br>
                    <label for="downloads">Downloads</label>
                    <input type="number" id="downloads" placeholder="Downloads"><br>
                    <label for="likes">Likes</label>
                    <input type="number" id="likes" placeholder="Likes"><br>
                    <label for="length">Length</label>
                    <select name="length" id="length">
                        <option value="null">Unknown</option>
                        <option value="0">Tiny</option>
                        <option value="1">Short</option>
                        <option value="2">Medium</option>
                        <option value="3">Long</option>
                        <option value="4">XL / Extra-Long</option>
                        <option value="5">Plat.</option>
                    </select><br>
                    <label for="official_song">Official Song</label>
                    <select name="official_song" id="official_song">
                        <option value="null">Unknown/None</option>
                        <option value="-1">Practice: Stay Inside Me</option>
                        <option value="0">Stereo Madness</option>
                        <option value="1">Back on Track</option>
                        <option value="2">Polargeist</option>
                        <option value="3">Dry Out</option>
                        <option value="4">Base After Base</option>
                        <option value="5">Can't Let Go</option>
                        <option value="6">Jumper</option>
                        <option value="7">Time Machine</option>
                        <option value="8">Cycles</option>
                        <option value="9">xStep</option>
                        <option value="10">Clutterfunk</option>
                        <option value="11">Theory of Everything</option>
                        <option value="12">Electroman Adventures</option>
                        <option value="13">Clubstep</option>
                        <option value="14">Electrodynamix</option>
                        <option value="15">Hexagon Force</option>
                        <option value="16">Blast Processing</option>
                        <option value="17">Theory of Everything 2</option>
                        <option value="18">Geometrical Dominator</option>
                        <option value="19">Deadlocked</option>
                        <option value="20">Fingerdash</option>
                        <option value="21">Dash</option>
                        <option value="22">Explorers</option>
                        <option value="23">The Seven Seas</option>
                        <option value="24">Viking Arena</option>
                        <option value="25">Airborne Robots</option>
                        <option value="26">Secret</option>
                        <option value="27">Payload</option>
                        <option value="28">Beast Mode</option>
                        <option value="29">Machina</option>
                        <option value="30">Years</option>
                        <option value="31">Frontlines</option>
                        <option value="32">Space Pirates</option>
                        <option value="33">Striker</option>
                        <option value="34">Embers</option>
                        <option value="35">Round 1</option>
                        <option value="36">Monster Dance Off</option>
                        <option value="37">Press Start</option>
                        <option value="38">Nock Em</option>
                        <option value="39">Power Trip</option>
                    </select><br>
                    <label for="custom_song">Custom Song ID</label>
                    <input type="number" id="custom_song" placeholder="Custom Song ID"><br>
                    <label for="difficulty">Difficulty</label>
                    <select name="difficulty" id="difficulty">
                        <option value="null">N/A</option>
                        <option value="-1">Auto</option>
                        <option value="1">Easy</option>
                        <option value="2">Normal</option>
                        <option value="3">Hard</option>
                        <option value="4">Harder</option>
                        <option value="5">Insane</option>
                        <option value="8">Demon (Hard)</option>
                        <option value="6">Easy Demon</option>
                        <option value="7">Medium Demon</option>
                        <option value="9">Insane Demon</option>
                        <option value="10">Extreme Demon</option>
                    </select><br>
                    <label for="stars">Stars</label>
                    <input type="number" id="stars" placeholder="Stars" max="127" size=5><br>
                    <label for="feature_score">Feature Score</label>
                    <input type="number" id="feature_score" placeholder="Feature Score" size=9><br>
                    <label for="epic">Epic Rating</label>
                    <select name="epic" id="epic">
                        <option value="null">None</option>
                        <option value="1">Epic</option>
                        <option value="2">Legendary</option>
                        <option value="3">Mythic</option>
                    </select><br>
                    <label for="description">Description</label><br>
                    <textarea id="description" name="description" rows="4" cols="50"></textarea><br>
                    <label for="game_version">Game Version</label>
                    <select name="game_version" id="game_version">
                        <option value="null">Unknown/None</option>
                        <option value="1">1.0</option>
                        <option value="2">1.1</option>
                        <option value="3">1.2</option>
                        <option value="4">1.3</option>
                        <option value="5">1.4</option>
                        <option value="6">1.5</option>
                        <option value="7">1.6</option>
                        <option value="10">1.7</option>
                        <option value="11">Early 1.8</option>
                        <option value="18">1.8</option>
                        <option value="19">1.9</option>
                        <option value="20">2.0</option>
                        <option value="21">2.1</option>
                        <option value="22">2.2</option>
                    </select><br>
                    <label for="level_version">Level Version</label>
                    <input type="number" id="level_version" placeholder="Level Version" min=-128 max=127><br>
                    <label for="coins">Coins</label>
                    <input type="number" id="coins" placeholder="Coins" min=0 max=3><br>
                    <label for="coins_verified">Verified Coins</label>
                    <input type="checkbox" id="coins_verified"><br>
                    <label for="original">Original ID</label>
                    <input type="number" id="original" placeholder="Original ID"><br>
                    <br>
                    <div id="levelsLabel">1/1 Levels</div><br>
                    <button id="left" onclick="setIndex(index - 1)">&lt;</button>
                    <button id="add" onclick="add()">+</button>
                    <button id="right" onclick="setIndex(index + 1)">&gt;</button>
                    <button id="delete" onclick="del()">Delete</button>
                    <button id="clear" onclick="clearKevek()">Clear</button><br>
                </td>
            </tr>
        </table>
        <button id="download" onclick="download(`manual_${$('id').value}_${getTotalLevels()}.json`, JSON.stringify(getManual(), null, 4))">Download Manual</button>
        <script>
            let subs = [{levels: [{}]}]
            let index = 0
            let ssIndex = 0
            let subChangeables = ["comment_subsub", "date_subsub", "time_subsub", "seconds_subsub", "millis_subsub"]
            let statics = ["comment", "date", "time", "seconds", "millis", "unix", "unix_subsub", ...subChangeables]
            function $(id) {
                return document.getElementById(id)
            }

            $("comment_subsub").addEventListener("input", (ts) => {
                subs[ssIndex].comment = ts.target.value
            })

            function updateSSCreated() {
                let tz = (new Date()).getTimezoneOffset()
                subs[ssIndex].created = `${$("date_subsub").value} ${$("time_subsub").value}:${$("seconds_subsub").value.toString().padStart(2, "0")}.${$("millis_subsub").value.toString().padStart(3, "0")}${tz > 0 ? "-" : "+"}${Math.abs(Math.floor(tz / 60)).toString().padStart(2, "0")}:${(tz % 60).toString().padStart(2, "0")}`
            }

            for (let i of subChangeables) {
                if (i == "comment_subsub") continue
                $(i).addEventListener("input", () => {
                    updateSSCreated()
                })
            }
            
            for (let i of [...Array.from(document.getElementsByTagName("input")), ...Array.from(document.getElementsByTagName("textarea"))]) {
                if (statics.includes(i.id)) continue
                i.addEventListener("input", (ts) => {
                    if (ts.target.type == "checkbox") subs[ssIndex].levels[index][ts.target.id] = ts.target.checked
                    else subs[ssIndex].levels[index][ts.target.id] = ts.target.value
                })
            }
            for (let i of Array.from(document.getElementsByTagName("select"))) {
                i.addEventListener("change", (ts) => {
                    subs[ssIndex].levels[index][ts.target.id] = ts.target.value
                })
            }
            function getTotalLevels() {
                let total = 0
                for (let i of subs) total += i.levels.length
                return total
            }
            function add() {
                subs[ssIndex].levels.push({})
                setIndex(subs[ssIndex].levels.length - 1)
            }
            function addSS() {
                subs.push({levels: [{}]})
                setSSIndex(subs.length - 1)
            }

            function clearKevek() {
                subs[ssIndex].levels[index] = {}
                setIndex(index) // no more idiocracy reference
            }

            function clearSS() {
                subs[ssIndex] = {levels: [{}]}
                setSSIndex(ssIndex)
            }

            function setDate(date) {
                let d = new Date(date)
                $("date").value = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}-${(d.getDate()).toString().padStart(2, "0")}`
                $("time").value = `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`
                $("seconds").value = d.getSeconds()
                $("millis").value = d.getMilliseconds()
            }

            function setSSDate(date) {
                let d = new Date(date)
                $("date_subsub").value = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}-${(d.getDate()).toString().padStart(2, "0")}`
                $("time_subsub").value = `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`
                $("seconds_subsub").value = d.getSeconds()
                $("millis_subsub").value = d.getMilliseconds()
                updateSSCreated()
                // setSSIndex(ssIndex)
            }

            function del() {
                if (subs[ssIndex].levels.length < 2) return
                subs[ssIndex].levels[index] = null
                let oldLevels = subs[ssIndex].levels
                subs[ssIndex].levels = []
                for (let i of oldLevels) {
                    if (i != null) subs[ssIndex].levels.push(i)
                }
                setIndex(Math.max(0, index - 1))
            }

            function delSS() {
                if (subs.length < 2) return
                subs[ssIndex] = null
                let oldSubs = subs
                subs = []
                for (let i of oldSubs) {
                    if (i != null) subs.push(i)
                }
                setSSIndex(Math.max(0, ssIndex - 1))
            }

            function setIndex(ind) {
                ind = Math.max(0, Math.min(ind, subs[ssIndex].levels.length - 1))
                index = ind;
                subs[ssIndex].index = ind
                for (let i of [...Array.from(document.getElementsByTagName("input")), ...Array.from(document.getElementsByTagName("textarea")), ...Array.from(document.getElementsByTagName("select"))]) {
                    if (statics.includes(i.id)) continue
                    if (i.type == "checkbox") i.checked = subs[ssIndex].levels[index][i.id] || null
                    else i.value = subs[ssIndex].levels[index][i.id] || null
                }
                
                document.getElementById("levelsLabel").innerHTML = `${index + 1}/${subs[ssIndex].levels.length} Levels`
            }

            function setSSIndex(ind) {
                ind = Math.max(0, Math.min(ind, subs.length - 1))
                ssIndex = ind;
                $("comment_subsub").value = subs[ssIndex].comment || ""
                if (subs[ssIndex].created) {
                    $("date_subsub").value = subs[ssIndex].created.split(" ")[0]
                    let values = subs[ssIndex].created.split(" ")[1].split(":")
                    if (values.length == 4) {
                        $("time_subsub").value = `${values[0]}:${values[1]}`
                        $("seconds_subsub").value = Number(values[2].split(".")[0])
                        $("millis_subsub").value = Number(values[2].split(".")[1].split(/[+-]/)[0])
                    } else {
                        $("time_subsub").value = ""
                        $("seconds_subsub").value = ""
                        $("millis_subsub").value = ""
                    }
                } else {
                    $("date_subsub").value = ""
                    $("time_subsub").value = ""
                    $("seconds_subsub").value = ""
                    $("millis_subsub").value = ""
                }

                document.getElementById("subsLabel").innerHTML = `${ssIndex + 1}/${subs.length} Subsubmissions`

                setIndex(subs[ssIndex].index || 0)
            }

            function fileChanged(file) {
                let rawFile = file.files[0]
                if (rawFile) {
                    if (!confirm("Are you sure you want to override the current manual? Changes will not be saved!")) {
                        return
                    }
                    let reader = new FileReader()
                    reader.readAsText(rawFile, "UTF-8")
                    reader.onload = function (evt) {
                        try {
                            let json = JSON.parse(evt.target.result)
                            if (!json.submissions) {
                                alert("This manual is either invalid or does not have any subsubmissions!")
                                return
                            }
                            $("comment").value = json.comment || ""
                            let date = new Date(json.created)
                            $("date").value = json.created.split(" ")[0]
                            $("time").value = `${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`
                            $("seconds").value = date.getSeconds()
                            $("millis").value = date.getMilliseconds()
                            for (let sub = 0; sub < json.submissions.length; sub++) {
                                for (let i = 0; i < json.submissions[sub].levels.length; i++) {
                                    let level = json.submissions[sub].levels[i]
                                    if (level.auto) {
                                        level.difficulty = -1
                                    } else if (level.demon) {
                                        switch (level.demon_type) {
                                            case 3:
                                            case 4:
                                                level.difficulty = level.demon_type + 3
                                                break
                                            case 6:
                                            case 7:
                                                level.difficulty = level.demon_type + 4
                                                break
                                            default:
                                                level.difficulty = 8
                                                break
                                        }
                                    } else {
                                        if (level.rating_sum / level.rating) {
                                            level.difficulty = Math.floor(level.rating_sum / level.rating)
                                        }
                                    }
                                    json.submissions[sub].levels[i] = level
                                }
                            }
                            subs = json.submissions
                            setSSIndex(0)
                        } catch (e) {
                            console.error(e)
                            alert("Could not read file!")
                        }
                    }
                    reader.onerror = function (evt) {
                        alert("Could not read file!")
                    }
                }
            }

            function getManual() {
                let tz = (new Date()).getTimezoneOffset()
                let manual = {
                    comment: $("comment").value,
                    created: `${$("date").value} ${$("time").value}:${$("seconds").value.toString().padStart(2, "0")}.${$("millis").value.toString().padStart(3, "0")}${tz > 0 ? "-" : "+"}${Math.abs(Math.floor(tz / 60)).toString().padStart(2, "0")}:${(tz % 60).toString().padStart(2, "0")}`,
                    submissions: []
                }
                let ssIndexx = 0
                for (let sub of subs) {
                    let indexx = 0
                    manual.submissions.push({
                        comment: sub.comment,
                        created: sub.created,
                        levels: []
                    })
                    for (let i of sub.levels) {
                        let lvl = {}
                        if (!i.id) {
                            alert(`Level #${indexx + 1} (subsubmission #${ssIndexx + 1}): You must specify the level ID!`)
                            return null
                        }
                        function addToLevel(id, numerify) {
                            if (i[id]) lvl[id] = numerify ? Number(i[id]) : i[id]
                        }
                        addToLevel("id", true)
                        addToLevel("level_name")
                        addToLevel("username")
                        addToLevel("user_id", true)
                        addToLevel("downloads", true)
                        addToLevel("likes", true)
                        addToLevel("length", true)
                        addToLevel("official_song", true)
                        addToLevel("custom_song", true)
                        addToLevel("description")
                        addToLevel("game_version", true)
                        addToLevel("level_version", true)
                        addToLevel("stars", true)
                        addToLevel("feature_score", true)
                        addToLevel("epic", true)
                        addToLevel("coins", true)
                        addToLevel("original", true)
                        lvl.coins_verified = i.coins_verified
                        if (i.coins_verified == undefined || i.coins_verified == null) delete lvl.coins_verified
                        let difficulty = Number(i.difficulty)
                        switch (difficulty) {
                            case -1:
                                lvl.auto = true
                                break
                            case 8:
                                lvl.demon = true
                                break
                            case 6:
                            case 7:
                                lvl.demon = true
                                lvl.demon_type = difficulty - 3
                                break
                            case 9:
                            case 10:
                                lvl.demon = true
                                lvl.demon_type = difficulty - 4
                                break
                            case 1:
                            case 2:
                            case 3:
                            case 4:
                            case 5:
                                lvl.rating = 10
                                lvl.rating_sum = difficulty * 10
                                break
                            default:
                                break
                        }

                        manual.submissions[ssIndexx].levels.push(lvl)
                        indexx++
                    }
                    ssIndexx++
                }
                return manual
            }
            function download(filename, text) {
                if (text == "null") return;

                let element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }
        </script>
    </body>
</html>
