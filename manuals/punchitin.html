<html>
    <head>
        <title>Manual Generator</title>
    </head>
    <body>
        <label for="resume">Upload a manual:</label>
        <input type="file" onchange="fileChanged(this)" onclick="this.value=null;" id="resume" name="resume" accept=".json" /><br><br>
        <label for="comment">Manual Comment</label>
        <input type="text" id="comment" size="50" placeholder="Manual Comment"/><br>
        <label for="date">Manual Date (local timezone)</label>
        <input type="date" id="date"/><input type="time" id="time"/><input type="number" min="0" max="59" id="seconds" placeholder="Seconds" size="5"><input type="number" min="0" max="999" id="millis" placeholder="Millis" size="3">
        <button id="currentDate" onclick="setDate(Date.now())">Set to current date</button><br>
        <input type="number" id="unix" placeholder="UNIX timestamp" size="15">
        <button id="unixSeconds" onclick="setDate(Number($('unix').value) * 1000)">Set date (seconds)</button>
        <button id="unixMillis" onclick="setDate(Number($('unix').value))">Set date (milliseconds)</button><br><br>
        <label for="id">Level ID</label>
        <input type="number" id="id" placeholder="Level ID"><br>
        <label for="level_name">Level Name</label>
        <input type="text" id="level_name" placeholder="Level Name"><br>
        <label for="username">Author Username</label>
        <input type="text" id="username" placeholder="Username"><br>
        <label for="user_id">Author User ID</label>
        <input type="number" id="user_id" placeholder="User ID"><br>
        <label for="downloads">Downloads</label>
        <input type="number" id="downloads" placeholder="Downloads"><br>
        <label for="likes">Likes</label>
        <input type="number" id="likes" placeholder="Likes"><br>
        <label for="length">Length</label>
        <select name="length" id="length">
            <option value="null">Unknown</option>
            <option value="0">Tiny</option>
            <option value="1">Short</option>
            <option value="2">Medium</option>
            <option value="3">Long</option>
            <option value="4">XL / Extra-Long</option>
            <option value="5">Plat.</option>
        </select><br>
        <label for="official_song">Official Song</label>
        <select name="official_song" id="official_song">
            <option value="null">Unknown/None</option>
            <option value="-1">Practice: Stay Inside Me</option>
            <option value="0">Stereo Madness</option>
            <option value="1">Back on Track</option>
            <option value="2">Polargeist</option>
            <option value="3">Dry Out</option>
            <option value="4">Base After Base</option>
            <option value="5">Can't Let Go</option>
            <option value="6">Jumper</option>
            <option value="7">Time Machine</option>
            <option value="8">Cycles</option>
            <option value="9">xStep</option>
            <option value="10">Clutterfunk</option>
            <option value="11">Theory of Everything</option>
            <option value="12">Electroman Adventures</option>
            <option value="13">Clubstep</option>
            <option value="14">Electrodynamix</option>
            <option value="15">Hexagon Force</option>
            <option value="16">Blast Processing</option>
            <option value="17">Theory of Everything 2</option>
            <option value="18">Geometrical Dominator</option>
            <option value="19">Deadlocked</option>
            <option value="20">Fingerdash</option>
            <option value="21">Dash</option>
            <option value="22">Explorers</option>
            <option value="23">The Seven Seas</option>
            <option value="24">Viking Arena</option>
            <option value="25">Airborne Robots</option>
            <option value="26">Secret</option>
            <option value="27">Payload</option>
            <option value="28">Beast Mode</option>
            <option value="29">Machina</option>
            <option value="30">Years</option>
            <option value="31">Frontlines</option>
            <option value="32">Space Pirates</option>
            <option value="33">Striker</option>
            <option value="34">Embers</option>
            <option value="35">Round 1</option>
            <option value="36">Monster Dance Off</option>
            <option value="37">Press Start</option>
            <option value="38">Nock Em</option>
            <option value="39">Power Trip</option>
        </select><br>
        <label for="custom_song">Custom Song ID</label>
        <input type="number" id="custom_song" placeholder="Custom Song ID"><br>
        <label for="difficulty">Difficulty</label>
        <select name="difficulty" id="difficulty">
            <option value="null">N/A</option>
            <option value="-1">Auto</option>
            <option value="1">Easy</option>
            <option value="2">Normal</option>
            <option value="3">Hard</option>
            <option value="4">Harder</option>
            <option value="5">Insane</option>
            <option value="8">Demon (Hard)</option>
            <option value="6">Easy Demon</option>
            <option value="7">Medium Demon</option>
            <option value="9">Insane Demon</option>
            <option value="10">Extreme Demon</option>
        </select><br>
        <label for="stars">Stars</label>
        <input type="number" id="stars" placeholder="Stars" max="127" size=5><br>
        <label for="feature_score">Feature Score</label>
        <input type="number" id="feature_score" placeholder="Feature Score" size=9><br>
        <label for="epic">Epic Rating</label>
        <select name="epic" id="epic">
            <option value="null">None</option>
            <option value="1">Epic</option>
            <option value="2">Legendary</option>
            <option value="3">Mythic</option>
        </select><br>
        <label for="description">Description</label><br>
        <textarea id="description" name="description" rows="4" cols="50"></textarea><br>
        <label for="game_version">Game Version</label>
        <select name="game_version" id="game_version">
            <option value="null">Unknown/None</option>
            <option value="1">1.0</option>
            <option value="2">1.1</option>
            <option value="3">1.2</option>
            <option value="4">1.3</option>
            <option value="5">1.4</option>
            <option value="6">1.5</option>
            <option value="7">1.6</option>
            <option value="10">1.7</option>
            <option value="11">Early 1.8</option>
            <option value="18">1.8</option>
            <option value="19">1.9</option>
            <option value="20">2.0</option>
            <option value="21">2.1</option>
            <option value="22">2.2</option>
        </select><br>
        <label for="level_version">Level Version</label>
        <input type="number" id="level_version" placeholder="Level Version" min=-128 max=127><br>
        <label for="coins">Coins</label>
        <input type="number" id="coins" placeholder="Coins" min=0 max=3><br>
        <label for="coins_verified">Verified Coins</label>
        <input type="checkbox" id="coins_verified"><br>
        <label for="original">Original ID</label>
        <input type="number" id="original" placeholder="Original ID"><br>
        <br>
        <div id="levelsLabel">1/1 Levels</div><br>
        <button id="left" onclick="setIndex(index - 1)">&lt;</button>
        <button id="add" onclick="add()">+</button>
        <button id="right" onclick="setIndex(index + 1)">&gt;</button>
        <button id="delete" onclick="del()">Delete</button>
        <button id="clear" onclick="clearKevek()">Clear</button>
        <button id="copy" onclick="copy()">Copy</button>
        <button id="paste" onclick="paste()">Paste</button><br>
        <br>
        <button id="download" onclick="download(`manual_${$('id').value}_${levels.length}.json`, JSON.stringify(getManual(), null, 4))">Download Manual</button>
        <script>
            let levels = [{}]
            let index = 0
            let statics = ["comment", "date", "time", "seconds", "millis", "unix"]
            let copiedLevel = {}
            function $(id) {
                return document.getElementById(id)
            }
            for (let i of [...Array.from(document.getElementsByTagName("input")), ...Array.from(document.getElementsByTagName("textarea"))]) {
                if (statics.includes(i.id)) continue
                i.addEventListener("input", (ts) => {
                    if (ts.target.type == "checkbox") levels[index][ts.target.id] = ts.target.checked
                    else levels[index][ts.target.id] = ts.target.value
                })
            }
            for (let i of Array.from(document.getElementsByTagName("select"))) {
                i.addEventListener("change", (ts) => {
                    levels[index][ts.target.id] = ts.target.value
                })
            }

            function add() {
                levels.push({})
                setIndex(levels.length - 1)
            }

            function clearKevek() {
                levels[index] = {}
                setIndex(index) // updayett // yes this is an idiocracy reference
            }

            function copy() {
                copiedLevel = {}
                for (let i of Object.entries(levels[index])) {
                    copiedLevel[i[0]] = i[1]
                }
            }

            function paste() {
                levels[index] = {}
                for (let i of Object.entries(copiedLevel)) {
                    levels[index][i[0]] = i[1]
                }
                setIndex(index)
            }

            function setDate(date) {
                let d = new Date(date)
                $("date").value = `${d.getFullYear()}-${(d.getMonth() + 1).toString().padStart(2, "0")}-${(d.getDate()).toString().padStart(2, "0")}`
                $("time").value = `${d.getHours().toString().padStart(2, "0")}:${d.getMinutes().toString().padStart(2, "0")}`
                $("seconds").value = d.getSeconds()
                $("millis").value = d.getMilliseconds()
            }

            function del() {
                if (levels.length < 2) return
                levels[index] = null
                let oldLevels = levels
                levels = []
                for (let i of oldLevels) {
                    if (i != null) levels.push(i)
                }
                setIndex(Math.max(0, index - 1))
            }

            function setIndex(ind) {
                ind = Math.max(0, Math.min(ind, levels.length - 1))
                index = ind;
                for (let i of [...Array.from(document.getElementsByTagName("input")), ...Array.from(document.getElementsByTagName("textarea")), ...Array.from(document.getElementsByTagName("select"))]) {
                    if (statics.includes(i.id)) continue
                    if (i.type == "checkbox") i.checked = levels[index][i.id] || null
                    else i.value = levels[index][i.id] || null
                }

                document.getElementById("levelsLabel").innerHTML = `${index + 1}/${levels.length} Levels`
            }

            function fileChanged(file) {
                let rawFile = file.files[0]
                if (rawFile) {
                    if (!confirm("Are you sure you want to override the current manual? Changes will not be saved!")) {
                        return
                    }
                    let reader = new FileReader()
                    reader.readAsText(rawFile, "UTF-8")
                    reader.onload = function (evt) {
                        try {
                            let json = JSON.parse(evt.target.result)
                            if (!json.levels) {
                                if (json.submissions) {
                                    alert("This manual uses subsubmissions, which are not supported on this page!")
                                } else {
                                    alert("This manual either does not have any levels or is invalid!")
                                }
                                return
                            }
                            $("comment").value = json.comment || ""
                            let date = new Date(json.created)
                            $("date").value = json.created.split(" ")[0]
                            $("time").value = `${date.getHours().toString().padStart(2, "0")}:${date.getMinutes().toString().padStart(2, "0")}`
                            $("seconds").value = date.getSeconds()
                            $("millis").value = date.getMilliseconds()
                            levels = json.levels
                            setIndex(0)
                        } catch (e) {
                            console.error(e)
                            alert("Could not read file!")
                        }
                    }
                    reader.onerror = function (evt) {
                        alert("Could not read file!")
                    }
                }
            }

            function getManual() {
                let tz = (new Date()).getTimezoneOffset()
                let manual = {
                    comment: $("comment").value,
                    created: `${$("date").value} ${$("time").value}:${$("seconds").value.toString().padStart(2, "0")}.${$("millis").value.toString().padStart(3, "0")}${tz > 0 ? "-" : "+"}${Math.abs(Math.floor(tz / 60)).toString().padStart(2, "0")}:${(tz % 60).toString().padStart(2, "0")}`,
                    levels: []
                }
                let indexx = 0
                for (let i of levels) {
                    let lvl = {}
                    if (!i.id) {
                        alert(`Level #${indexx + 1}: You must specify the level ID!`)
                        return null
                    }
                    function addToLevel(id, numerify) {
                        if (i[id]) lvl[id] = numerify ? Number(i[id]) : i[id]
                    }
                    addToLevel("id", true)
                    addToLevel("level_name")
                    addToLevel("username")
                    addToLevel("user_id", true)
                    addToLevel("downloads", true)
                    addToLevel("likes", true)
                    addToLevel("length", true)
                    addToLevel("official_song", true)
                    addToLevel("custom_song", true)
                    addToLevel("description")
                    addToLevel("game_version", true)
                    addToLevel("level_version", true)
                    addToLevel("stars", true)
                    addToLevel("feature_score", true)
                    addToLevel("epic", true)
                    addToLevel("coins", true)
                    addToLevel("original", true)
                    lvl.coins_verified = i.coins_verified
                    if (i.coins_verified == undefined || i.coins_verified == null) delete lvl.coins_verified
                    let difficulty = Number(i.difficulty)
                    switch (difficulty) {
                        case -1:
                            lvl.auto = true
                            break
                        case 8:
                            lvl.demon = true
                            break
                        case 6:
                        case 7:
                            lvl.demon = true
                            lvl.demon_type = difficulty - 3
                            break
                        case 9:
                        case 10:
                            lvl.demon = true
                            lvl.demon_type = difficulty - 4
                            break
                        case 1:
                        case 2:
                        case 3:
                        case 4:
                        case 5:
                            lvl.rating = 10
                            lvl.rating_sum = difficulty * 10
                            break
                        default:
                            break
                    }

                    manual.levels.push(lvl)
                }
                return manual
            }
            function download(filename, text) {
                if (text == "null") return;

                let element = document.createElement('a');
                element.setAttribute('href', 'data:text/plain;charset=utf-8,' + encodeURIComponent(text));
                element.setAttribute('download', filename);

                element.style.display = 'none';
                document.body.appendChild(element);

                element.click();

                document.body.removeChild(element);
            }
        </script>
    </body>
</html>
